---
import Layout from "../layouts/Layout.astro";
import InputGroup from "../components/InputGroup.astro";
import SelectGroup from "../components/forms/SelectGroup.astro";
import TextAreaGroup from "../components/TextAreaGroup.astro";
import TabNavigation from "../components/forms/TabNavigation.astro";
import ToastContainer from "../components/ui/ToastContainer.astro";
import HistoryPanel from "../components/HistoryPanel.astro";
import Skeleton from "../components/ui/Skeleton.astro";
import KopSuratConfig from "../components/forms/KopSuratConfig.astro";
import {
	Bot,
	FileText,
	Printer,
	Copy,
	Save,
	RefreshCw,
	FileDown,
	RotateCcw,
	Upload,
	Download,
} from "@lucide/astro";
---

<Layout title="Generator Laporan Kinerja AI">
	<ToastContainer />

	<main
		class="container mx-auto px-4 py-4 max-w-[1600px] min-h-screen flex flex-col"
		x-data="appFinal"
		@keydown.window.prevent.ctrl.s="saveHistory()"
		@keydown.window.prevent.ctrl.g="generate()"
	>
		<header
			class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 border-b border-white/10 pb-4 no-print"
		>
			<div>
				<h1
					class="text-2xl font-bold text-white tracking-tight flex items-center gap-2"
				>
					<Bot class="text-blue-500" /> Generator Laporan Kinerja
				</h1>
				<p class="text-slate-400 text-xs mt-1">
					Sistem Otomasi Pelaporan Pegawai Berbasis AI
				</p>
			</div>
			<div
				class="hidden md:flex flex-col items-end text-[10px] text-slate-500 font-mono"
			>
				<span>Ctrl+G: Generate</span>
				<span>Ctrl+S: Save Draft</span>
			</div>
		</header>

		<div
			class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-1 h-[calc(100vh-140px)] min-h-[600px]"
		>
			<!-- INPUT PANEL -->
			<div
				class="lg:col-span-4 xl:col-span-3 flex flex-col h-full bg-slate-900/50 rounded-xl border border-white/5 overflow-hidden shadow-2xl glass-panel"
			>
				<div class="p-3 border-b border-white/5 bg-slate-950/30">
					<TabNavigation />
				</div>

				<div
					class="flex-1 overflow-y-auto p-4 space-y-6 custom-scrollbar scroll-smooth"
				>
					<!-- Config Instansi -->
					<div
						x-show="activeTab === 'instansi'"
						class="space-y-4 animate-fade-in"
					>
						<KopSuratConfig />
					</div>

					<!-- Config Pribadi -->
					<div
						x-show="activeTab === 'pribadi'"
						class="space-y-4 animate-fade-in"
					>
						<h3
							class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1 border-b border-white/5 pb-2"
						>
							Data Pribadi
						</h3>
						<InputGroup
							label="Nama Lengkap & Gelar"
							name="nama"
							model="form.nama"
							placeholder="Contoh: Yahya Zulfikri, S.Kom"
						/>
						<div class="grid grid-cols-2 gap-3">
							<InputGroup label="NIP / NUPTK" name="nip" model="form.nip" />
							<SelectGroup
								label="Gender"
								name="gender"
								model="form.gender"
								options={[
									{ val: "L", label: "Laki-laki" },
									{ val: "P", label: "Perempuan" },
								]}
							/>
						</div>
						<InputGroup label="Unit Kerja" name="unit" model="form.unitKerja" />
						<InputGroup label="Jabatan" name="jabatan" model="form.jabatan" />
					</div>

					<!-- Config Kepegawaian -->
					<div
						x-show="activeTab === 'pegawai'"
						class="space-y-4 animate-fade-in"
					>
						<h3
							class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1 border-b border-white/5 pb-2"
						>
							Kepegawaian
						</h3>
						<div class="grid grid-cols-2 gap-3">
							<SelectGroup
								label="Jenis Pegawai"
								name="jenis"
								model="form.jenisPegawai"
								options={[
									{ val: "Guru", label: "Guru" },
									{ val: "Staf", label: "Staf Admin" },
								]}
							/>
							<SelectGroup
								label="Status"
								name="status"
								model="form.statusKepegawaian"
								options={[
									{ val: "PNS", label: "PNS" },
									{ val: "PPPK", label: "PPPK" },
									{ val: "Honorer", label: "Honorer" },
								]}
							/>
						</div>
						<div class="grid grid-cols-2 gap-3">
							<InputGroup
								label="Golongan"
								name="gol"
								model="form.golongan"
								placeholder="III/a (Opsional)"
							/>
							<InputGroup
								label="Tgl Mulai Laporan"
								name="tgl"
								model="form.tglMulai"
								type="date"
							/>
						</div>
					</div>

					<!-- Config Dikjar (Guru Only) -->
					<div
						x-show="activeTab === 'dikjar'"
						class="space-y-4 animate-fade-in"
					>
						<template x-if="form.jenisPegawai === 'Guru'">
							<div class="space-y-4">
								<h3
									class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1 border-b border-white/5 pb-2"
								>
									Pendidikan
								</h3>
								<InputGroup
									label="Mata Pelajaran"
									name="mapel"
									model="form.mapel"
								/>
								<div class="grid grid-cols-2 gap-3">
									<SelectGroup
										label="Jenjang"
										name="jenjang"
										model="form.jenjang"
										options={[
											{ val: "SD", label: "SD/MI" },
											{ val: "SMP", label: "SMP/MTS" },
											{ val: "SMA", label: "SMA/MA" },
										]}
									/>
									<InputGroup
										label="Jam/Minggu"
										name="jam"
										model="form.jamMengajar"
										type="number"
									/>
								</div>
								<InputGroup
									label="Kelas Ajar"
									name="kelas"
									model="form.kelas"
									placeholder="VII-A, VII-B"
								/>
								<SelectGroup
									label="Kurikulum"
									name="kurikulum"
									model="form.kurikulum"
									options={[
										{ val: "Merdeka", label: "Kur. Merdeka" },
										{ val: "K13", label: "K13 Revisi" },
									]}
								/>
							</div>
						</template>
						<template x-if="form.jenisPegawai !== 'Guru'">
							<div
								class="py-10 text-slate-500 text-sm text-center border border-dashed border-white/10 rounded-lg bg-white/5"
							>
								<p>Menu ini khusus untuk Guru</p>
							</div>
						</template>
					</div>

					<!-- Config Tugas -->
					<div x-show="activeTab === 'tugas'" class="space-y-4 animate-fade-in">
						<h3
							class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1 border-b border-white/5 pb-2"
						>
							Uraian Tugas
						</h3>
						<TextAreaGroup
							label="Tugas Pokok"
							name="pokok"
							model="form.tugasPokok"
							rows="3"
						/>
						<TextAreaGroup
							label="Tugas Tambahan"
							name="tambahan"
							model="form.tugasTambahan"
							rows="2"
						/>
						<template x-if="form.jenisPegawai === 'Guru'">
							<InputGroup
								label="Ekstrakurikuler"
								name="ekskul"
								model="form.ekskul"
								placeholder="Pramuka"
							/>
						</template>
					</div>

					<!-- Config Opsi -->
					<div
						x-show="activeTab === 'config'"
						class="space-y-4 animate-fade-in"
					>
						<h3
							class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1 border-b border-white/5 pb-2"
						>
							Pengaturan AI
						</h3>
						<div class="grid grid-cols-2 gap-3">
							<SelectGroup
								label="Bulan"
								name="bulan"
								model="form.bulan"
								options={Array.from({ length: 12 }, (_, i) => ({
									val: String(i + 1),
									label: new Date(0, i).toLocaleString("id-ID", {
										month: "long",
									}),
								}))}
							/>
							<InputGroup
								label="Tahun"
								name="tahun"
								model="form.tahun"
								type="number"
							/>
						</div>
						<SelectGroup
							label="Model AI"
							name="model"
							model="form.modelAI"
							options={[
								{ val: "gemini-2.5-flash", label: "Gemini 2.5 Flash" },
								{ val: "gemini-1.5-flash", label: "Gemini 1.5 Flash" },
							]}
						/>

						<div class="mt-4 pt-4 border-t border-white/10">
							<div class="grid grid-cols-2 gap-2">
								<button
									@click="exportData"
									class="flex items-center justify-center gap-2 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs rounded-lg border border-white/5 transition"
									><Download class="w-3 h-3" /> Backup JSON</button
								>
								<label
									class="flex items-center justify-center gap-2 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs rounded-lg border border-white/5 transition cursor-pointer"
									><Upload class="w-3 h-3" /> Restore JSON <input
										type="file"
										accept=".json"
										class="hidden"
										@change="importData"
									/></label
								>
							</div>
						</div>
					</div>
				</div>

				<div
					class="p-4 border-t border-white/10 bg-slate-900/80 backdrop-blur space-y-3 z-10"
				>
					<button
						@click="generate"
						:disabled="loading"
						class="btn-primary w-full flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-wait group relative overflow-hidden"
					>
						<RefreshCw x-show="loading" class="w-4 h-4 animate-spin" />
						<Bot x-show="!loading" class="w-4 h-4" />
						<span
							x-text="loading ? 'Sedang Menyusun Laporan...' : 'GENERATE AI'"
							class="relative font-bold tracking-wide"></span>
					</button>
					<div class="flex gap-2">
						<button
							@click="resetForm"
							class="flex-1 py-2 text-xs text-red-400 hover:bg-red-500/10 border border-red-500/20 rounded-lg transition flex justify-center items-center gap-2"
							><RotateCcw class="w-3 h-3" /> Reset</button
						>
						<button
							@click="saveHistory"
							class="flex-[2] py-2 text-xs font-medium text-slate-300 hover:text-white border border-white/10 hover:bg-white/5 rounded-lg transition flex justify-center items-center gap-2"
							><Save class="w-3 h-3" /> Simpan Draft</button
						>
					</div>
				</div>
			</div>

			<!-- PREVIEW PANEL -->
			<div
				class="lg:col-span-8 xl:col-span-7 flex flex-col h-full glass-panel overflow-hidden relative"
			>
				<div
					class="bg-slate-950/60 p-3 border-b border-white/10 flex justify-between items-center backdrop-blur-sm z-20 no-print"
				>
					<span
						class="text-slate-300 font-medium text-sm flex items-center gap-2 px-2"
						><FileText class="w-4 h-4 text-blue-400" /> Preview Dokumen</span
					>
					<div class="flex gap-2">
						<button
							@click="copyText"
							class="p-2 hover:bg-white/10 rounded-lg text-slate-400 hover:text-white transition"
							title="Copy Markdown"><Copy class="w-4 h-4" /></button
						>
						<div class="h-8 w-px bg-white/10 mx-1"></div>
						<button
							@click="exportWord"
							class="px-3 py-1.5 bg-blue-700/50 hover:bg-blue-600/50 text-blue-100 border border-blue-500/30 rounded-lg text-xs font-medium flex gap-2 items-center transition"
							><FileDown class="w-3.5 h-3.5" /> .docx</button
						>
						<button
							@click="printPDF"
							class="px-3 py-1.5 bg-rose-700/50 hover:bg-rose-600/50 text-rose-100 border border-rose-500/30 rounded-lg text-xs font-medium flex gap-2 items-center transition"
							><Printer class="w-3.5 h-3.5" /> PDF</button
						>
					</div>
				</div>

				<div
					class="flex-1 bg-white overflow-y-auto p-8 md:p-12 relative group scroll-smooth text-black"
				>
					<div
						x-show="loading"
						class="absolute inset-0 bg-slate-900/10 backdrop-blur-sm z-50 flex items-start pt-20 justify-center"
					>
						<div
							class="bg-slate-800 rounded-xl shadow-2xl border border-white/10 p-2 max-w-md w-full mx-4"
						>
							<Skeleton />
							<p class="text-center text-slate-400 text-sm pb-4 animate-pulse">
								AI sedang menyusun laporan...
							</p>
						</div>
					</div>

					<template x-if="!renderedHtml && !loading">
						<div
							class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 gap-4 select-none bg-slate-900"
						>
							<div
								class="p-6 rounded-full bg-slate-800 border-4 border-slate-700"
							>
								<Bot class="w-12 h-12 text-slate-500" />
							</div>
							<div class="text-center">
								<p class="font-bold text-slate-500 text-lg">
									Siap Menyusun Laporan
								</p>
								<p class="text-sm text-slate-600 mt-1 max-w-xs mx-auto">
									Isi data disamping, lalu klik Generate AI.
								</p>
							</div>
						</div>
					</template>

					<div
						id="report-preview"
						class="relative z-10 text-black min-h-[1000px] flex flex-col max-w-[210mm] mx-auto bg-white shadow-sm print:shadow-none"
						x-show="renderedHtml"
					>
						<!-- KOP SURAT LENGKAP -->
						<table
							class="w-full border-b-4 border-double border-black mb-6"
							style="border-bottom: 4px double black;"
						>
							<tr>
								<!-- Logo Kiri -->
								<td class="w-24 align-middle text-center p-2 border-none">
									<template x-if="form.logoInstitusiBase64">
										<img
											:src="form.logoInstitusiBase64"
											class="w-20 h-20 object-contain mx-auto"
										/>
									</template>
								</td>
								<!-- Text Tengah -->
								<td class="align-middle text-center p-2 border-none">
									<h3
										class="font-bold text-lg uppercase leading-tight"
										x-text="form.institusiBarisSatuNama"
										style="font-family: Arial, sans-serif;"
									>
									</h3>
									<h2
										class="font-bold text-xl uppercase leading-tight"
										x-text="form.institusiBarisDuaNama"
										style="font-family: Arial, sans-serif;"
									>
									</h2>
									<h1
										class="font-bold text-2xl uppercase leading-tight mt-1"
										x-text="form.instansiNama"
										style="font-family: Arial, sans-serif;"
									>
									</h1>
									<p class="text-sm mt-1" x-text="form.instansiAlamat"></p>
									<p class="text-xs italic" x-text="form.instansiWebsite"></p>
								</td>
								<!-- Logo Kanan -->
								<td class="w-24 align-middle text-center p-2 border-none">
									<template x-if="form.logoInstansiBase64">
										<img
											:src="form.logoInstansiBase64"
											class="w-20 h-20 object-contain mx-auto"
										/>
									</template>
								</td>
							</tr>
						</table>

						<!-- JUDUL LAPORAN -->
						<div class="text-center mb-8 text-black">
							<h1
								class="text-lg font-bold underline uppercase tracking-wider mb-1"
								style="font-family: Arial, sans-serif;"
							>
								LAPORAN KINERJA PEGAWAI
							</h1>
							<p class="text-sm font-medium">
								Periode: <span x-text="getBulanNama(form.bulan)"></span>
								<span x-text="form.tahun"></span>
							</p>
						</div>

						<!-- CONTENT (MARKDOWN) -->
						<div class="w-full overflow-x-auto">
							<div
								x-html="renderedHtml"
								class="prose-report max-w-none text-black mb-8 min-w-[100%]"
							>
							</div>
						</div>

						<!-- TTD -->
						<div
							class="mt-8 pt-8 break-inside-avoid text-black flex justify-end"
						>
							<div class="flex flex-col items-center w-80 text-center">
								<p class="mb-6 text-sm">
									<span x-text="form.titimangsa"></span>
								</p>
								<p class="font-bold mb-2 text-sm">Yang Melaporkan,</p>
								<div class="w-20 h-20 my-2 relative flex justify-center">
									<img
										:src="qrCodeUrl"
										class="w-full h-full object-contain opacity-80"
										x-show="qrCodeUrl"
									/>
								</div>
								<p
									class="font-bold underline text-sm uppercase"
									x-text="form.nama"
								>
								</p>
								<p class="text-sm">NIP. <span x-text="form.nip"></span></p>
							</div>
						</div>
					</div>
				</div>
			</div>

			<div class="hidden xl:block xl:col-span-2 h-full no-print">
				<HistoryPanel />
			</div>
		</div>
	</main>
</Layout>

<script>
	import Alpine from "alpinejs";
	import {
		reportStore,
		saveToHistory,
		resetStore,
	} from "../stores/reportStore";
	import { addToast } from "../stores/toastStore";
	import { generateLaporan } from "../services/aiService";
	import { parseMarkdown } from "../utils/markdown";
	import html2pdf from "html2pdf.js";
	import { asBlob } from "html-docx-js-typescript";
	import { saveAs } from "file-saver";
	import QRCode from "qrcode";

	document.addEventListener("alpine:init", () => {
		Alpine.data("appFinal", () => ({
			loading: false,
			renderedHtml: "",
			activeTab: "pribadi",
			qrCodeUrl: "",
			form: reportStore.get(),
			saveTimeout: null,
			tabs: [
				{ id: "instansi", label: "Instansi" },
				{ id: "pribadi", label: "Pribadi" },
				{ id: "pegawai", label: "Kerja" },
				{ id: "dikjar", label: "Dikjar" },
				{ id: "tugas", label: "Tugas" },
				{ id: "config", label: "Opsi" },
			],

			async init() {
				if (this.form.generatedContent) {
					this.renderedHtml = await parseMarkdown(this.form.generatedContent);
					await this.generateQR();
				}
				this.$watch("form", (val) => {
					if (this.saveTimeout) clearTimeout(this.saveTimeout);
					this.saveTimeout = setTimeout(() => reportStore.set({ ...val }), 500);
				});
				reportStore.subscribe(async (newState) => {
					if (JSON.stringify(newState) !== JSON.stringify(this.form)) {
						this.form = { ...newState };
						if (newState.generatedContent) {
							this.renderedHtml = await parseMarkdown(
								newState.generatedContent
							);
							await this.generateQR();
						}
					}
				});
			},

			// LOGIC BARU: Handle Upload untuk field dinamis (logoInstitusi / logoInstansi)
			handleLogoUpload(event, fieldName) {
				const file = event.target.files[0];
				if (!file) return;
				if (file.size > 500 * 1024) {
					// Max 500KB
					addToast("Ukuran file maksimal 500KB", "error");
					return;
				}
				const reader = new FileReader();
				reader.onload = (e) => {
					this.form[fieldName] = e.target.result;
				};
				reader.readAsDataURL(file);
			},

			getBulanNama(bulan) {
				if (!bulan) return "";
				return new Date(0, parseInt(bulan) - 1).toLocaleString("id-ID", {
					month: "long",
				});
			},

			async generateQR() {
				if (!this.form.nama) return;
				const data = `Tanda Tangan Digital\nNama: ${this.form.nama}\nNIP: ${this.form.nip}\nUnit: ${this.form.unitKerja}\nTanggal: ${this.form.titimangsa}\nStatus: Valid`;
				try {
					this.qrCodeUrl = await QRCode.toDataURL(data, {
						width: 120,
						margin: 0,
						color: { dark: "#000000", light: "#ffffff" },
					});
				} catch (err) {
					console.error(err);
				}
			},

			async generate() {
				if (!this.form.nama || !this.form.nip) {
					addToast("Nama dan NIP wajib diisi!", "error");
					this.activeTab = "pribadi";
					return;
				}
				this.loading = true;
				try {
					const rawMarkdown = await generateLaporan();
					this.renderedHtml = await parseMarkdown(rawMarkdown);
					await this.generateQR();
					this.form.generatedContent = rawMarkdown;
					addToast("Laporan berhasil disusun!", "success");
					saveToHistory();
				} catch (e) {
					console.error(e);
					addToast("Gagal: " + (e.message || "Cek Koneksi"), "error");
				} finally {
					this.loading = false;
				}
			},

			resetForm() {
				if (confirm("Reset data form?")) {
					resetStore();
					this.renderedHtml = "";
					this.qrCodeUrl = "";
					addToast("Formulir direset", "info");
				}
			},

			saveHistory() {
				if (!this.renderedHtml) {
					addToast("Belum ada laporan", "info");
					return;
				}
				if (saveToHistory()) addToast("Draft tersimpan", "success");
			},

			async copyText() {
				if (!this.form.generatedContent) return;
				try {
					await navigator.clipboard.writeText(this.form.generatedContent);
					addToast("Markdown disalin", "success");
				} catch (e) {
					addToast("Gagal menyalin", "error");
				}
			},

			async exportWord() {
				if (!this.renderedHtml) {
					addToast("Laporan belum dibuat", "error");
					return;
				}
				addToast("Menyiapkan dokumen Word...", "info");
				const contentElement = document.getElementById("report-preview");
				const htmlString = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body { font-family: 'Arial', sans-serif; font-size: 11pt; } table { width: 100%; border-collapse: collapse; } td, th { border: 1px solid black; padding: 5px; } .border-none { border: none !important; }</style></head><body>${contentElement.innerHTML}</body></html>`;
				try {
					const blob = await asBlob(htmlString, {
						orientation: "portrait",
						margins: { top: 720, right: 720, bottom: 720, left: 720 },
					});
					saveAs(blob, `Laporan_${this.form.nama.replace(/\s+/g, "_")}.docx`);
					addToast("Download berhasil", "success");
				} catch (error) {
					console.error(error);
					addToast("Gagal export Word", "error");
				}
			},

			printPDF() {
				if (!this.renderedHtml) return;
				const element = document.getElementById("report-preview");
				const fileName = `Laporan_${this.form.nama.replace(/\s+/g, "_")}.pdf`;
				const opt = {
					margin: [10, 15, 15, 15],
					filename: fileName,
					image: { type: "jpeg", quality: 0.98 },
					html2canvas: { scale: 2, useCORS: true },
					jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
				};
				addToast("Memproses PDF...", "info");
				html2pdf()
					.set(opt)
					.from(element)
					.save()
					.then(() => addToast("PDF diunduh", "success"))
					.catch(() => addToast("Gagal export PDF", "error"));
			},

			exportData() {
				const data = reportStore.get();
				const blob = new Blob([JSON.stringify(data, null, 2)], {
					type: "application/json",
				});
				saveAs(
					blob,
					`Backup_Laporan_${new Date().toISOString().slice(0, 10)}.json`
				);
			},

			importData(event) {
				const file = event.target.files[0];
				if (!file) return;
				const reader = new FileReader();
				reader.onload = (e) => {
					try {
						const json = JSON.parse(e.target.result);
						reportStore.set(json);
						this.form = json;
						addToast("Data dipulihkan", "success");
					} catch (err) {
						addToast("File corrupt", "error");
					}
				};
				reader.readAsText(file);
				event.target.value = "";
			},
		}));
	});
</script>
