---
// src/components/ui/ProgressBar.astro
---

<div
	x-data="progressBar"
	x-show="isGenerating"
	x-transition:enter="transition ease-out duration-300"
	x-transition:enter-start="opacity-0 scale-95"
	x-transition:enter-end="opacity-100 scale-100"
	x-transition:leave="transition ease-in duration-200"
	x-transition:leave-start="opacity-100 scale-100"
	x-transition:leave-end="opacity-0 scale-95"
	class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center no-print"
	style="display: none;"
>
	<div class="glass-panel p-6 max-w-md w-full mx-4">
		<!-- Header -->
		<div class="flex items-center gap-3 mb-4">
			<div class="relative">
				<svg
					class="animate-spin h-8 w-8 text-blue-400"
					xmlns="http://www.w3.org/2000/svg"
					fill="none"
					viewBox="0 0 24 24"
				>
					<circle
						class="opacity-25"
						cx="12"
						cy="12"
						r="10"
						stroke="currentColor"
						stroke-width="4"></circle>
					<path
						class="opacity-75"
						fill="currentColor"
						d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
					></path>
				</svg>
			</div>
			<div class="flex-1">
				<h3 class="text-white font-bold">Generating Report</h3>
				<p class="text-xs text-slate-400" x-text="currentStep"></p>
			</div>
		</div>

		<!-- Progress Bar -->
		<div class="mb-4">
			<div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden">
				<div
					class="bg-gradient-to-r from-blue-500 to-indigo-500 h-full transition-all duration-500 ease-out"
					:style="`width: ${progress}%`"
				></div>
			</div>
			<div class="flex justify-between items-center mt-2 text-xs">
				<span class="text-slate-400" x-text="`${progress}% complete`"></span>
				<span class="text-slate-400" x-text="estimatedTime"></span>
			</div>
		</div>

		<!-- Steps -->
		<div class="space-y-2">
			<template x-for="(step, index) in steps" :key="index">
				<div class="flex items-center gap-2 text-sm">
					<!-- Icon -->
					<div
						class="w-5 h-5 rounded-full flex items-center justify-center"
						:class="{
							'bg-blue-500': step.status === 'current',
							'bg-emerald-500': step.status === 'completed',
							'bg-slate-700': step.status === 'pending'
						}"
					>
						<svg
							x-show="step.status === 'completed'"
							class="w-3 h-3 text-white"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="3"
								d="M5 13l4 4L19 7"></path>
						</svg>
						<div
							x-show="step.status === 'current'"
							class="w-2 h-2 bg-white rounded-full animate-pulse"
						></div>
					</div>

					<!-- Label -->
					<span
						:class="{
							'text-white font-medium': step.status === 'current',
							'text-emerald-400': step.status === 'completed',
							'text-slate-500': step.status === 'pending'
						}"
						x-text="step.label"
					></span>
				</div>
			</template>
		</div>

		<!-- Cancel Button -->
		<button
			@click="cancel"
			class="mt-4 w-full py-2 text-sm text-slate-400 hover:text-white border border-slate-700 hover:border-slate-600 rounded-lg transition"
		>
			Cancel
		</button>
	</div>
</div>

<script>
	document.addEventListener("alpine:init", () => {
		Alpine.data("progressBar", () => ({
			isGenerating: false,
			progress: 0,
			currentStep: "",
			estimatedTime: "",
			steps: [
				{ label: "Validating data...", status: "pending" },
				{ label: "Connecting to AI...", status: "pending" },
				{ label: "Processing content...", status: "pending" },
				{ label: "Formatting document...", status: "pending" },
				{ label: "Finalizing...", status: "pending" },
			],
			startTime: null,
			progressInterval: null,

			init() {
				// Listen to generate events
				window.addEventListener("generate:start", () => {
					this.start();
				});

				window.addEventListener("generate:complete", () => {
					this.complete();
				});

				window.addEventListener("generate:error", () => {
					this.error();
				});
			},

			start() {
				this.isGenerating = true;
				this.progress = 0;
				this.startTime = Date.now();
				this.resetSteps();
				this.animateProgress();
			},

			animateProgress() {
				let currentStepIndex = 0;

				this.progressInterval = setInterval(() => {
					// Update progress
					if (this.progress < 90) {
						this.progress += Math.random() * 10;
						if (this.progress > 90) this.progress = 90;
					}

					// Update steps
					if (this.progress > currentStepIndex * 20) {
						if (currentStepIndex > 0) {
							this.steps[currentStepIndex - 1].status = "completed";
						}
						if (currentStepIndex < this.steps.length) {
							this.steps[currentStepIndex].status = "current";
							this.currentStep = this.steps[currentStepIndex].label;
							currentStepIndex++;
						}
					}

					// Update estimated time
					const elapsed = Date.now() - this.startTime;
					const estimated = (elapsed / this.progress) * (100 - this.progress);
					this.estimatedTime = `~${Math.ceil(estimated / 1000)}s remaining`;
				}, 500);
			},

			complete() {
				clearInterval(this.progressInterval);
				this.progress = 100;
				this.steps.forEach((step) => (step.status = "completed"));
				this.currentStep = "Complete!";
				this.estimatedTime = "Done";

				setTimeout(() => {
					this.isGenerating = false;
				}, 1000);
			},

			error() {
				clearInterval(this.progressInterval);
				this.isGenerating = false;
			},

			cancel() {
				clearInterval(this.progressInterval);
				this.isGenerating = false;
				window.dispatchEvent(new CustomEvent("generate:cancel"));
			},

			resetSteps() {
				this.steps.forEach((step) => (step.status = "pending"));
			},
		}));
	});
</script>