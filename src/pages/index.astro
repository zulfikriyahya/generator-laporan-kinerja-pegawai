---
import Layout from "../layouts/Layout.astro";
import FormInstansi from "../components/forms/FormInstansi.astro";
import FormPegawai from "../components/forms/FormPegawai.astro";
import FormAkademik from "../components/forms/FormAkademik.astro";
import FormKinerja from "../components/forms/FormKinerja.astro";
import SelectGroup from "../components/forms/SelectGroup.astro";
import InputGroup from "../components/InputGroup.astro";
import ToastContainer from "../components/ui/ToastContainer.astro";
import AutoSaveIndicator from "../components/ui/AutoSaveIndicator.astro";
import KeyboardShortcuts from "../components/ui/KeyboardShortcuts.astro";
import ZoomControl from "../components/ui/ZoomControl.astro";
import ProgressBar from "../components/ui/ProgressBar.astro";
import DocumentStats from "../components/ui/DocumentStats.astro";
import {
	Bot,
	FileSpreadsheet,
	RefreshCw,
	Printer,
	Save,
	CircleAlert,
	Download,
	FileText,
	History,
} from "@lucide/astro";
---

<Layout title="Generator Laporan Kinerja Pegawai AI - v1.0.0">
	<ToastContainer />
	<AutoSaveIndicator />
	<KeyboardShortcuts />
	<ZoomControl />
	<ProgressBar />
	<DocumentStats />
	<main class="w-full min-h-screen flex flex-col bg-[#0f172a]" x-data="appCore">
		<header
			class="h-16 border-b border-white/10 bg-slate-900/90 backdrop-blur flex items-center justify-between px-6 fixed top-0 w-full z-40 no-print shadow-md"
		>
			<div class="flex items-center gap-3">
				<div
					class="bg-gradient-to-br from-blue-600 to-indigo-600 p-2 rounded-lg shadow-lg shadow-blue-500/20"
				>
					<Bot class="text-white w-5 h-5" />
				</div>
				<div>
					<h1 class="text-sm font-bold text-white tracking-wide">
						E-KINERJA AI
					</h1>
					<p class="text-[10px] text-slate-400">Ver 1.0.0 Stable</p>
				</div>
			</div>

			<div class="flex items-center gap-2">
				<button
					@click="downloadTemplate"
					class="px-3 py-1.5 bg-slate-800 text-slate-300 border border-slate-700 rounded-md text-xs font-medium hover:bg-slate-700 transition flex items-center gap-2"
					title="Download Template Excel"
				>
					<Download class="w-3.5 h-3.5" /> Template
				</button>

				<label
					class="px-3 py-1.5 bg-emerald-600/20 text-emerald-400 border border-emerald-500/30 rounded-md text-xs font-medium cursor-pointer hover:bg-emerald-600/30 transition flex items-center gap-2"
				>
					<FileSpreadsheet class="w-3.5 h-3.5" /> Import
					<input
						type="file"
						class="hidden"
						accept=".xlsx,.xls"
						@change="handleImportExcel"
					/>
				</label>

				<div class="h-6 w-px bg-white/10 mx-2"></div>

				<button
					@click="exportPDF"
					class="px-3 py-1.5 bg-red-600/20 text-red-400 border border-red-500/30 rounded-md text-xs font-medium hover:bg-red-600/30 transition flex items-center gap-2"
					title="Export PDF"
				>
					<FileText class="w-3.5 h-3.5" /> PDF
				</button>

				<button
					@click="exportDOCX"
					class="px-3 py-1.5 bg-blue-600/20 text-blue-400 border border-blue-500/30 rounded-md text-xs font-medium hover:bg-blue-600/30 transition flex items-center gap-2"
					title="Export DOCX"
				>
					<FileText class="w-3.5 h-3.5" /> DOCX
				</button>

				<div class="h-6 w-px bg-white/10 mx-2"></div>

				<button
					@click="saveDraft"
					class="text-slate-400 hover:text-white transition"
					title="Simpan Draft"
				>
					<Save class="w-5 h-5" />
				</button>

				<button
					@click="toggleHistory"
					class="text-slate-400 hover:text-white transition"
					title="Riwayat"
				>
					<History class="w-5 h-5" />
				</button>
			</div>
		</header>

		<div class="flex-1 mt-16 flex overflow-hidden h-[calc(100vh-64px)]">
			<aside
				class="w-[420px] flex flex-col border-r border-white/10 bg-slate-900 overflow-hidden no-print z-30 shadow-[4px_0_24px_rgba(0,0,0,0.4)]"
			>
				<div class="p-4 bg-slate-800/50 border-b border-white/5 space-y-3">
					<div class="grid grid-cols-2 gap-2">
						<SelectGroup
							label="Bulan"
							name="bln"
							model="form.config.bulan"
							options={Array.from({ length: 12 }, (_, i) => ({
								val: String(i + 1),
								label: new Date(0, i).toLocaleString("id-ID", {
									month: "long",
								}),
							}))}
						/>
						<InputGroup
							label="Tahun"
							name="thn"
							model="form.config.tahun"
							type="number"
						/>
					</div>

					<div>
						<SelectGroup
							label="Model AI"
							name="ai"
							model="form.config.modelAI"
							options={[
								{
									val: "gemini",
									label: "Google Gemini 2.0 Flash (FREE & Fast)",
								},
								{
									val: "groq",
									label: "Groq Llama 3.3 70B (FREE & Ultra Fast)",
								},
								{ val: "together", label: "Together AI Llama 3.3 (FREE)" },
								{ val: "deepseek", label: "DeepSeek Chat (Very Cheap)" },
								{ val: "gpt", label: "OpenAI GPT-4o Mini (Cheap)" },
								{ val: "claude", label: "Claude Sonnet 4 (Premium)" },
							]}
						/>
						<p
							class="text-[10px] text-slate-500 mt-1"
							x-show="!hasAPIKey(form.config.modelAI)"
						>
							⚠️ API Key belum diatur untuk model ini
						</p>
					</div>

					<div>
						<InputGroup
							label="Token Limit"
							name="tkn"
							model="form.config.tokenLimit"
							type="number"
						/>
					</div>
				</div>

				<div class="flex border-b border-white/5 bg-slate-950/30">
					<template x-for="tab in tabs" :key="tab.id">
						<button
							@click="activeTab = tab.id"
							:class="activeTab === tab.id ? 'text-blue-400 border-b-2 border-blue-400 bg-white/5' : 'text-slate-500 hover:text-slate-300'"
							class="flex-1 py-3 text-xs font-medium transition text-center"
							x-text="tab.label"
						>
						</button>
					</template>
				</div>

				<div class="flex-1 overflow-y-auto custom-scrollbar p-5 space-y-6">
					<div x-show="activeTab === 'instansi'" x-transition>
						<FormInstansi />
					</div>

					<div x-show="activeTab === 'pegawai'" x-transition>
						<FormPegawai />
					</div>

					<div x-show="activeTab === 'akademik'" x-transition>
						<div
							x-show="!isJabatanGuru()"
							class="text-center p-6 border border-dashed border-white/10 rounded"
						>
							<CircleAlert class="w-8 h-8 text-slate-600 mx-auto mb-2" />
							<p class="text-xs text-slate-500">
								Data akademik khusus untuk Jabatan Guru (fungsional)
							</p>
							<p class="text-[10px] text-slate-600 mt-1">
								Jabatan saat ini: <span
									class="font-medium"
									x-text="form.pegawai.jabatan"></span>
							</p>
						</div>
						<div x-show="isJabatanGuru()">
							<FormAkademik />
						</div>
					</div>

					<div x-show="activeTab === 'kinerja'" x-transition>
						<FormKinerja />
					</div>

					<div x-show="activeTab === 'advanced'" x-transition>
						<div class="space-y-4">
							<h3
								class="text-xs font-bold text-blue-400 uppercase tracking-widest"
							>
								Instruksi Tambahan AI
							</h3>
							<textarea
								x-model="form.config.customInstruction"
								placeholder="Tambahkan instruksi khusus untuk AI (opsional)..."
								rows="6"
								class="w-full bg-slate-950/30 border border-white/10 rounded-lg px-4 py-3 text-sm text-slate-100 focus:outline-none focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 resize-none custom-scrollbar"
							></textarea>
							<p class="text-[10px] text-slate-500">
								Contoh: "Fokuskan pada pencapaian target IKU" atau "Tambahkan
								analisis SWOT"
							</p>
						</div>
					</div>
				</div>

				<div class="p-4 border-t border-white/10 bg-slate-900 z-50">
					<button
						@click="generateLaporan"
						:disabled="loading || !canGenerate()"
						class="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg text-white font-bold text-sm shadow-lg hover:shadow-blue-500/20 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2 transition-all active:scale-[0.98]"
					>
						<RefreshCw :class="loading && 'animate-spin'" class="w-4 h-4" />
						<span
							x-text="loading ? 'AI Sedang Bekerja...' : 'GENERATE LAPORAN'"
						>
						</span>
					</button>

					<div
						x-show="validationErrors.length > 0"
						class="mt-2 p-2 bg-red-500/10 border border-red-500/30 rounded text-xs text-red-400"
					>
						<template x-for="error in validationErrors">
							<div x-text="'• ' + error"></div>
						</template>
					</div>
				</div>
			</aside>

			<section
				class="flex-1 bg-slate-200 overflow-y-auto relative flex flex-col items-center py-10 print:p-0 print:bg-white custom-scrollbar"
			>
				<div class="fixed top-24 right-8 z-20 flex flex-col gap-3 no-print">
					<button
						@click="printDoc"
						:disabled="!hasContent()"
						class="p-3 bg-slate-800 text-white rounded-full shadow-xl hover:bg-slate-700 transition hover:scale-110 disabled:opacity-50 disabled:cursor-not-allowed"
						title="Print Dokumen"
					>
						<Printer class="w-6 h-6" />
					</button>
				</div>

				<div
					id="document-preview"
					class="w-[210mm] min-h-[297mm] bg-white shadow-2xl print:shadow-none p-[2cm] text-black relative origin-top transition-transform duration-300"
				>
					<header class="mb-6 pb-2">
						<!-- Logo dan Header -->
						<div
							class="grid grid-cols-[100px_1fr_100px] gap-4 items-center mb-2"
						>
							<!-- Logo Kiri -->
							<div class="h-20 flex items-center justify-center">
								<template x-if="form.instansi.logoUtama">
									<img
										:src="form.instansi.logoUtama"
										class="max-w-full max-h-full object-contain"
										alt="Logo Kementerian Agama"
									/>
								</template>
							</div>

							<!-- Header Text (Tengah) -->
							<div class="text-center leading-tight">
								<h3
									class="font-bold text-[13px] uppercase"
									x-text="form.instansi.header1"
								>
								</h3>
								<h2
									class="font-bold text-[13px] uppercase"
									x-text="form.instansi.header2"
								>
								</h2>
								<h1
									class="font-bold text-[15px] uppercase"
									x-text="form.instansi.header3"
								>
								</h1>
								<p
									class="text-[11px] normal-case mt-1"
									x-text="form.instansi.alamat"
								>
								</p>
								<p class="text-[11px] mt-0.5">
									Website: <span x-text="form.instansi.website"></span> | Email: <span
										x-text="form.instansi.email"></span>
								</p>
							</div>

							<!-- Logo Kanan -->
							<div class="h-20 flex items-center justify-center">
								<template x-if="form.instansi.logoInstansi">
									<img
										:src="form.instansi.logoInstansi"
										class="max-w-full max-h-full object-contain"
										alt="Logo Madrasah"
									/>
								</template>
							</div>
						</div>

						<!-- Garis Pembatas Double -->
						<div class="border-t-4 border-black"></div>
						<div class="border-t border-black mt-0.5"></div>
					</header>

					<!-- JUDUL LAPORAN -->
					<div class="text-center mb-8">
						<h2 class="font-bold uppercase text-lg">LAPORAN KINERJA PEGAWAI</h2>
						<p class="text-sm font-medium mt-1">
							Periode Laporan: <span
								x-text="getBulanName(form.config.bulan).toUpperCase()"></span>
							<span x-text="form.config.tahun"></span>
						</p>
					</div>

					<div
						x-show="!hasContent()"
						class="h-96 flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-lg bg-slate-50"
					>
						<Bot class="w-12 h-12 text-slate-300 mb-2" />
						<p class="text-sm text-slate-500 font-medium">
							Preview dokumen kosong
						</p>
						<p class="text-xs text-slate-400 mt-1">
							Isi form dan klik "Generate Laporan" untuk memulai
						</p>
					</div>

					<article
						class="prose-report text-justify leading-relaxed font-serif"
						x-html="renderedHTML"
						x-show="hasContent()"
					>
					</article>

					<div
						x-show="hasContent()"
						class="mt-12 flex justify-end break-inside-avoid"
					>
						<div class="text-center w-64">
							<p class="mb-1">
								<span x-text="form.instansi.titimangsa"></span>, <span
									x-text="getCurrentDate()"></span>
							</p>
							<p class="font-bold mb-2">Pejabat Penilai,</p>

							<div class="h-20 flex items-center justify-center my-1">
								<template x-if="form.instansi.kepala.ttd">
									<img
										:src="form.instansi.kepala.ttd"
										class="max-h-20 object-contain"
										alt="TTD"
									/>
								</template>
								<template x-if="!form.instansi.kepala.ttd">
									<div
										class="border-2 border-slate-200 p-1 bg-slate-50 opacity-60 rounded"
									>
										<div
											class="w-16 h-16 flex flex-col items-center justify-center text-[8px] text-center text-slate-400"
										>
											<div class="w-8 h-8 bg-slate-300 mb-1 rounded-sm"></div>
											DIGITAL SIGN
										</div>
									</div>
								</template>
							</div>

							<p
								class="font-bold underline uppercase text-sm"
								x-text="form.instansi.kepala.nama"
							>
							</p>
							<p class="text-sm">
								NIP. <span x-text="form.instansi.kepala.nip"></span>
							</p>
						</div>
					</div>
				</div>

				<div class="h-20 w-full no-print"></div>
			</section>
		</div>

		<div
			x-show="showHistory"
			@click.away="showHistory = false"
			x-transition:enter="transition ease-out duration-300"
			x-transition:enter-start="translate-x-full"
			x-transition:enter-end="translate-x-0"
			x-transition:leave="transition ease-in duration-200"
			x-transition:leave-start="translate-x-0"
			x-transition:leave-end="translate-x-full"
			class="fixed right-0 top-16 bottom-0 w-80 bg-slate-900 border-l border-white/10 z-30 overflow-y-auto custom-scrollbar no-print"
		>
			<div class="p-4">
				<div class="flex justify-between items-center mb-4">
					<h3 class="text-white font-bold flex items-center gap-2">
						<History class="w-4 h-4" /> Riwayat
					</h3>
					<button
						@click="showHistory = false"
						class="text-slate-500 hover:text-white"
					>
						✕
					</button>
				</div>

				<div class="space-y-2">
					<template x-if="historyItems.length === 0">
						<div class="text-center text-slate-500 text-sm py-8">
							Belum ada riwayat tersimpan
						</div>
					</template>

					<template x-for="item in historyItems" :key="item.id">
						<div
							class="p-3 rounded-lg bg-white/5 border border-white/5 hover:border-white/20 transition group"
						>
							<div class="flex justify-between items-start mb-1">
								<span
									class="text-xs text-blue-400"
									x-text="formatDate(item.date)"
								>
								</span>
								<button
									@click="deleteHistoryItem(item.id)"
									class="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition"
								>
									✕
								</button>
							</div>
							<div
								class="text-sm font-medium text-slate-200 mb-2"
								x-text="item.title"
							>
							</div>
							<button
								@click="loadHistoryItem(item.id)"
								class="w-full py-1.5 text-xs bg-white/5 hover:bg-blue-500/20 hover:text-blue-300 rounded border border-transparent hover:border-blue-500/30 transition"
							>
								Muat Data
							</button>
						</div>
					</template>
				</div>
			</div>
		</div>
	</main>
</Layout>
<script>
	import {
		reportStore,
		historyStore,
		saveToHistory,
		loadFromHistory,
		deleteHistory,
		validateBeforeGenerate,
	} from "../stores/reportStore";
	import { generateLaporan, checkAPIKey } from "../services/aiService";
	import { importFromExcel, downloadTemplate } from "../services/excelService";
	import {
		exportToPDF,
		exportToDOCX,
		printDocument,
	} from "../services/exportService";
	import { parseMarkdown } from "../utils/markdown";
	import { addToast } from "../stores/toastStore";

	document.addEventListener("alpine:init", () => {
		Alpine.data("appCore", () => ({
			tabs: [
				{ id: "instansi", label: "1. Instansi" },
				{ id: "pegawai", label: "2. Pegawai" },
				{ id: "akademik", label: "3. Akademik" },
				{ id: "kinerja", label: "4. Kinerja" },
				{ id: "advanced", label: "5. Advanced" },
			],
			activeTab: "pegawai",
			form: reportStore.get(),
			loading: false,
			renderedHTML: "",
			showHistory: false,
			historyItems: [],
			validationErrors: [],

			async init() {
				if (this.form.output.content) {
					this.renderedHTML = await parseMarkdown(this.form.output.content);
				}

				this.historyItems = historyStore.get().items;
				historyStore.subscribe((val) => {
					this.historyItems = val.items;
				});

				let timeout;
				this.$watch("form", (val) => {
					clearTimeout(timeout);
					window.dispatchEvent(new CustomEvent("autosave:start"));

					timeout = setTimeout(() => {
						try {
							reportStore.set(JSON.parse(JSON.stringify(val)));
							window.dispatchEvent(new CustomEvent("autosave:success"));
						} catch (error) {
							window.dispatchEvent(new CustomEvent("autosave:error"));
						}
					}, 800);
				});

				this.registerShortcuts();
			},

			registerShortcuts() {
				window.addEventListener("shortcut:generate", () =>
					this.generateLaporan(),
				);
				window.addEventListener("shortcut:save", () => this.saveDraft());
				window.addEventListener("shortcut:export-pdf", () => this.exportPDF());
				window.addEventListener("shortcut:export-docx", () =>
					this.exportDOCX(),
				);
				window.addEventListener("shortcut:toggle-history", () =>
					this.toggleHistory(),
				);

				window.addEventListener("shortcut:next-tab", () => {
					const currentIndex = this.tabs.findIndex(
						(t) => t.id === this.activeTab,
					);
					const nextIndex = (currentIndex + 1) % this.tabs.length;
					this.activeTab = this.tabs[nextIndex].id;
				});

				window.addEventListener("shortcut:prev-tab", () => {
					const currentIndex = this.tabs.findIndex(
						(t) => t.id === this.activeTab,
					);
					const prevIndex =
						(currentIndex - 1 + this.tabs.length) % this.tabs.length;
					this.activeTab = this.tabs[prevIndex].id;
				});
			},

			async generateLaporan() {
				const validation = validateBeforeGenerate(this.form);
				if (!validation.valid) {
					this.validationErrors = validation.errors;
					addToast("Data belum lengkap! Periksa form.", "error");
					return;
				}

				this.validationErrors = [];
				this.loading = true;
				window.dispatchEvent(new CustomEvent("generate:start"));

				try {
					const result = await generateLaporan();

					if (result.success && result.content) {
						this.renderedHTML = await parseMarkdown(result.content);
						this.form = reportStore.get();
						window.dispatchEvent(new CustomEvent("generate:complete"));
						addToast(
							`Laporan berhasil dibuat (${result.tokensUsed || 0} tokens)`,
							"success",
						);
						saveToHistory();
					} else {
						throw new Error(result.error || "Gagal generate laporan");
					}
				} catch (error) {
					console.error("Generate Error:", error);
					window.dispatchEvent(new CustomEvent("generate:error"));
					addToast(
						"Error: " + (error.message || "Gagal menghubungi AI"),
						"error",
					);
				} finally {
					this.loading = false;
				}
			},

			async handleImportExcel(event) {
				const input = event.target;
				const file = input.files?.[0];
				if (!file) return;

				try {
					await importFromExcel(file);
					this.form = reportStore.get();
					addToast("Import data berhasil!", "success");
				} catch (error) {
					addToast("Import gagal: " + error.message, "error");
				}

				input.value = "";
			},

			downloadTemplate() {
				try {
					downloadTemplate();
					addToast("Template Excel berhasil diunduh", "info");
				} catch (error) {
					addToast("Gagal download template", "error");
				}
			},

			async exportPDF() {
				if (!this.hasContent()) {
					addToast("Belum ada konten untuk diexport", "error");
					return;
				}

				try {
					const result = await exportToPDF();
					if (result.success) {
						addToast("PDF berhasil diexport", "success");
					} else {
						throw new Error(result.error);
					}
				} catch (error) {
					addToast("Export PDF gagal: " + error.message, "error");
				}
			},

			async exportDOCX() {
				if (!this.hasContent()) {
					addToast("Belum ada konten untuk diexport", "error");
					return;
				}

				try {
					const result = await exportToDOCX();
					if (result.success) {
						addToast("DOCX berhasil diexport", "success");
					} else {
						throw new Error(result.error);
					}
				} catch (error) {
					addToast("Export DOCX gagal: " + error.message, "error");
				}
			},

			printDoc() {
				if (!this.hasContent()) {
					addToast("Belum ada konten untuk diprint", "error");
					return;
				}
				printDocument();
			},

			saveDraft() {
				saveToHistory();
				addToast("Draft tersimpan ke riwayat", "success");
			},

			toggleHistory() {
				this.showHistory = !this.showHistory;
			},

			loadHistoryItem(id) {
				if (confirm("Muat data ini? Data saat ini akan ditimpa.")) {
					const success = loadFromHistory(id);
					if (success) {
						this.form = reportStore.get();
						this.showHistory = false;
						addToast("Data berhasil dimuat dari riwayat", "success");
					}
				}
			},

			deleteHistoryItem(id) {
				if (confirm("Hapus riwayat ini?")) {
					deleteHistory(id);
					addToast("Riwayat dihapus", "info");
				}
			},

			isJabatanGuru() {
				const jabatan = this.form.pegawai.jabatan.toLowerCase();
				return jabatan.includes("guru");
			},

			canGenerate() {
				return (
					!!this.form.pegawai.nama &&
					!!this.form.config.bulan &&
					!!this.form.config.tahun
				);
			},

			hasContent() {
				return !!this.form.output.content;
			},

			hasAPIKey(model) {
				return checkAPIKey(model);
			},

			getBulanName(bulan) {
				const idx = parseInt(bulan);
				if (!idx) return "";
				return new Date(0, idx - 1).toLocaleString("id-ID", { month: "long" });
			},

			getCurrentDate() {
				return new Date().toLocaleDateString("id-ID", {
					day: "numeric",
					month: "long",
					year: "numeric",
				});
			},

			formatDate(isoDate) {
				return new Date(isoDate).toLocaleString("id-ID", {
					day: "2-digit",
					month: "short",
					year: "numeric",
					hour: "2-digit",
					minute: "2-digit",
				});
			},

			handleUpload(event, field) {
				const input = event.target;
				const file = input.files?.[0];
				if (!file) return;

				if (file.size > 500 * 1024) {
					addToast("File terlalu besar (Max 500KB)", "error");
					return;
				}

				const reader = new FileReader();
				reader.onload = (e) => {
					const path = field.split(".");
					let target = this.form;
					for (let i = 0; i < path.length - 1; i++) {
						target = target[path[i]];
					}
					target[path[path.length - 1]] = e.target?.result;
				};
				reader.readAsDataURL(file);
			},
		}));
	});
</script>
